(function(){"use strict";const d=new Map,M=5e3,m=s=>{if(!s)return"";const e=s.toString().trim();if(d.has(e))return d.get(e);const r=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(d.size>=M){const t=d.keys().next().value;d.delete(t)}return d.set(e,r),r},A=s=>{let e=0;for(let r=0;r<s.length;r++){const t=s.charCodeAt(r);e=(e<<5)-e+t,e|=0}return Math.abs(e).toString(36)},R=s=>m(s).replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,60),b=new Map,F=1e3,$=s=>{const e=`${s}`;if(b.has(e))return b.get(e);const r=typeof s=="string"?Number(s):s;if(!Number.isFinite(r))return"Fecha inválida";const t=Math.abs(r)>=1e12,n=new Date(t?r:r*1e3);if(isNaN(n.getTime()))return"Fecha inválida";const i=new Intl.DateTimeFormat("es-ES",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}).format(n);if(b.size>=F){const p=b.keys().next().value;b.delete(p)}return b.set(e,i),i},w=s=>{const e=s.match(/\bp:(\d+)(?:-(\d+))?\b/i);if(!e)return null;const r=Number(e[1]),t=e[2]?Number(e[2]):r;return{from:r,to:t}},H=s=>{const e=s.match(/\bc:"([^"]+)"|\bc:(\S+)/i);return e?e[1]||e[2]:null},I=s=>{const e=s.trim();if(!e)return{phrases:[],terms:[],page:null,chapter:null};const r=w(e),t=H(e),i=e.replace(/\bp:\d+(?:-\d+)?\b/gi,"").replace(/\bc:"[^"]+"|\bc:\S+/gi,"").trim().match(/"([^"]+)"|\S+/g)||[],p=[],l=[];for(const a of i)if(a.startsWith('"')&&a.endsWith('"')){const h=a.slice(1,-1).trim();h&&p.push(m(h))}else{const h=m(a);h&&l.push(h)}return{phrases:p,terms:l,page:r,chapter:t}};let C=[],E=[];const S=new Map,N=s=>{C=[];const e=new Map,r=new Set;if(d.clear(),b.clear(),S.clear(),!s?.length)return{books:[],count:0};for(let t=0;t<s.length;t++){const n=s[t];if(!n)continue;const i=n.entries??[];if(i.length===0)continue;const p=n.author??"Desconocido",l=n.title??"Sin título",a=m(l),h=[];for(let u=0;u<i.length;u++){const g=i[u];if(!g)continue;const o=g.text??"";if(!o.trim())continue;const c=m(o),f=Number(g.page??0),y=`${a}|${f}|${c}`;if(r.has(y))continue;r.add(y);const _=g.chapter??"",P=$(g.time??0),k={id:g.id??`${R(l)}-${f}-${A(o)}`,Autor:p,Libro:l,Capitulo:_,Highlight:o,Pagina:f,Fecha:P,searchText:`${a} ${c}`,normTitle:a,normHighlight:c};C.push(k),h.push(k)}if(h.length>0){e.set(l,(e.get(l)??0)+h.length),S.has(l)||S.set(l,[]);const u=S.get(l);for(let g=0;g<h.length;g++)u.push(h[g])}}for(const t of S.values())t.sort((n,i)=>(n.Pagina??0)-(i.Pagina??0));return E=Array.from(e,([t,n])=>({title:t,count:n})).filter(t=>t.count>=10).sort((t,n)=>t.title.localeCompare(n.title,"es",{sensitivity:"base"})),{books:E,count:C.length}},z=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),T=(s,e)=>{const r=(e??"").trim();if(!r)return s;const{phrases:t,terms:n,page:i,chapter:p}=I(r);let l=r.replace(/\bp:\d+(?:-\d+)?\b/gi,"").replace(/\bc:"[^"]+"|\bc:\S+/gi,"").trim();const a=m(l),h=a?new RegExp(`\\b${z(a)}\\b`,"i"):null;let u=s;if(i&&(u=u.filter(o=>o.Pagina>=i.from&&o.Pagina<=i.to)),p){const o=m(p);u=u.filter(c=>m(c.Capitulo).includes(o))}if(!t.length&&!n.length)return u;u=u.filter(o=>!(t.length>0&&!t.every(f=>o.searchText.includes(f))||n.length>0&&!n.every(f=>o.searchText.includes(f))));const g=u.map(o=>{let c=0;const f=o.normHighlight||m(o.Highlight),y=o.normTitle||m(o.Libro);return f===a||y===a?c=1e3:f.startsWith(a)||y.startsWith(a)?c=500:h&&(h.test(f)||h.test(y))?c=100:f.includes(a)||y.includes(a)?c=10:c=1,{item:o,score:c}});return g.sort((o,c)=>c.score-o.score),g.map(o=>o.item)};self.onmessage=s=>{const{type:e,payload:r,id:t}=s.data;try{switch(e){case"PROCESS_DATA":{const n=N(r);self.postMessage({type:"DATA_PROCESSED",payload:n,id:t});break}case"SEARCH_MAIN":{const{query:n}=r,i=T(C,n);self.postMessage({type:"SEARCH_RESULTS",payload:i,id:t});break}case"INIT_FUSE":break;case"SEARCH_BOOK":{const{bookTitle:n,query:i}=r,p=S.get(n)||[],l=T(p,i);self.postMessage({type:"SEARCH_RESULTS",payload:l,id:t});break}}}catch(n){console.error("Worker Error:",n),self.postMessage({type:"ERROR",payload:n.message,id:t})}}})();
